


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by Free CSS Templates
http://www.freecsstemplates.org
Released for free under a Creative Commons Attribution 2.5 License

Name       : Pollinating  
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20101114

-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    
  <title>Gregory Szorc's Digital Home
  | Lost Productivity Due to Non-Unified Repositories
</title>
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
<link rel="alternate" type="application/atom+xml" title="Atom 1.0"
href="/blog/feed/atom" />
<link rel="stylesheet" href="/style/style.css" type="text/css" />
<link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />


  </head>
  <body>
    <div id="wrapper">
      
  <div id="menu">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/notes">Notes</a></li>
    <li><a href="/work.html">Work</a></li>
    <li><a href="/skills.html">Skills</a></li>
    <li><a href="/thoughts.html">Thoughts</a></li>
    <li><a href="/resume.pdf">Resume</a></li>
  </ul>
</div>


      <div id="page">
        <div id="page-bgtop">
          <div id="page-bgbtm">
              <div id="content">
                

<div class="blog_post">
  <a name="lost-productivity-due-to-non-unified-repositories"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/02/17/lost-productivity-due-to-non-unified-repositories" rel="bookmark" title="Permanent Link to Lost Productivity Due to Non-Unified Repositories">Lost Productivity Due to Non-Unified Repositories</a></h2>
  <small>February 17, 2015 at 02:50 PM | categories: 

<a href='/blog/category/mozilla'>Mozilla</a>
</small><p/>
  <div class="post_prose">
    
  <p>I'm currently working on
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1132771">annotating moz.build files with metadata</a>
that defines things like which bug component and code reviewers map to
which files. It's going to enable a lot of awesomeness.</p>
<p>As part of this project, I'm implementing a new moz.build processing
mode. Instead of reading moz.build files by traversing <em>DIRS</em> variables
from previously-executed moz.build files, we're evaluating moz.build
files according to filesystem topology. This has uncovered a few
cases where a moz.build file errors because of assumptions that no
longer hold. For example, for directories that are only active on
Windows, the moz.build file might assume that <em>if Windows</em> is always true.</p>
<p>One such problem was with
<a href="https://dxr.mozilla.org/mozilla-central/source/gfx/angle/src/libGLESv2/moz.build">gfx/angle/srx/libGLESv2/moz.build</a>.
This file contained code similar to the following:</p>
<pre><code>if CONFIG['IS_WINDOWS']:
    SOURCES += ['foo.cpp']
...
SOURCES['foo.cpp'].flags += ['-DBAR']
</code></pre>
<p>This always ran without issue because this moz.build was only included
if building for Windows. This assumption is of course invalid when in
filesystem traversal mode.</p>
<p>Anyway, as part of updating this trouble file, I lost maybe an hour
of productivity. Here's how.</p>
<p>The top of the trouble moz.build file has a comment:</p>
<pre><code># Please note this file is autogenerated from generate_mozbuild.py,
# so do not modify it directly
</code></pre>
<p>OK. So, I need to modify <em>generate_mozbuild.py</em>. First thing's first: I
need to locate it:</p>
<pre><code>$ hg locate generate_mozbuild.py
gfx/skia/generate_mozbuild.py
</code></pre>
<p>So I load up this file. I see a <em>main()</em>. I run the script in my shell
and get an error. Weird. I look around <em>gfx/skia</em> and see a README_MOZILLA
file. I open it. README_MOZILLA contains some instructions. They aren't
very good. I hop in #gfx on IRC and ask around. They tell me to do a
Subversion clone of Skia and to check out the commit referenced in
README_MOZILLA. There is no repo URL in README_MOZILLA. I search Google.
I find a Git URL. I notice that README_MOZILLA contains a SHA-1 commit,
not a Subversion integer revision. I figure the Git repo is what was
meant. I clone the Git repo. I attempt to run the generation script
referenced by README_MOZILLA. It fails. I ask again in #gfx. They are
baffled at first. I dig around the source code. I see a reference in
Skia's upstream code to a path that doesn't exist. I tell the #gfx
people. They tell me sub-repos are likly involved and to use <em>gclient</em>
to clone the repo. I search for the proper Skia source code docs and
type the necessary gclient commands. (Fortunately I've used gclient
before, so this wasn't completely alien to me.)</p>
<p>I get the Skia clone in the proper state. I run the generation script
and all works. But I don't see it writing the trouble moz.build file I
set out to fix. I set some breakpoints. I run the code again. I'm
baffled.</p>
<p>Suddenly it hits me: I've been poking around with <em>gfx/skia</em> which is
separate from <em>gfx/angle</em>! I look around <em>gfx/angle</em> and see
a README.mozilla file. I open it. It reveals the existence of the Git
repo <a href="https://github.com/mozilla/angle">https://github.com/mozilla/angle</a>.
I open GitHub in my browser. I see a <em>generate_mozbuild.py</em> script.</p>
<p>I now realize there are multiple files named <em>generate_mozbuild.py</em>.
Unfortunately, the one I care about - the ANGLE one - is not checked
into mozilla-central. So, my search for it with <em>hg files</em> did not
reveal its existence. Between me trying to get the Skia code cloned and
generating moz.build files, I probably lost an hour of work. All because
a file with a similar name wasn't checked into mozilla-central!</p>
<p>I assumed that the single <em>generate_mozbuild.py</em> I found under source
control was the only file of that name and that it <em>must</em> be the file
I was interested in.</p>
<p>Maybe I should have known to look at <em>gfx/angle/README.mozilla</em> first.
Maybe I should have known that <em>gfx/angle</em> and <em>gfx/skia</em> are completely
independent.</p>
<p>But I didn't. My ignorance cost me.</p>
<p>Had the contents of the separate ANGLE repository been checked into
mozilla-central, I would have seen the multiple <em>generate_mozbuild.py</em>
files and I would likely have found the correct one immediately. But
they weren't and I lost an hour of my time.</p>
<p>And I'm not done. Now I have to figure out how the separate ANGLE repo
integrates with mozilla-central. I'll have to figure out how to submit the
patch I still need to write. The GitHub description of this repo says
<em>Talk to vlad, jgilbert, or kamidphish for more info</em>. So now I have to
bother them before I can submit my patch. Maybe I'll just submit a pull
request and see what happens.</p>
<p>I'm convinced I wouldn't have encountered this problem if a
<a href="/blog/2014/09/09/on-monolithic-repositories/">monolithic repository</a>
were used. I would have found the separate <em>generate_mozbuild.py</em> file
immediately. And, the change process would likely have been known to me
since all the code was in a repository I already knew how to submit
patches from.</p>
<p>Separate repos are just lots of pain. You can bet I'll link to this post
when people propose splitting up mozilla-central into multiple
repositories.</p>

  </div>
</div>




              </div>
              
          <div id="sidebar">
          <ul>
            <li>
              <h2>Categories</h2>
              <ul>
                <li><a href="/blog/category/apple">Apple</a></li>
                <li><a href="/blog/category/bugzilla">Bugzilla</a></li>
                <li><a href="/blog/category/ci">CI</a></li>
                <li><a href="/blog/category/clang">Clang</a></li>
                <li><a href="/blog/category/docker">Docker</a></li>
                <li><a href="/blog/category/firefox">Firefox</a></li>
                <li><a href="/blog/category/git">Git</a></li>
                <li><a href="/blog/category/javascript">JavaScript</a></li>
                <li><a href="/blog/category/mercurial">Mercurial</a></li>
                <li><a href="/blog/category/mozreview">MozReview</a></li>
                <li><a href="/blog/category/mozilla">Mozilla</a></li>
                <li><a href="/blog/category/personal">Personal</a></li>
                <li><a href="/blog/category/programming">Programming</a></li>
                <li><a href="/blog/category/puppet">Puppet</a></li>
                <li><a href="/blog/category/pyoxidizer">PyOxidizer</a></li>
                <li><a href="/blog/category/python">Python</a></li>
                <li><a href="/blog/category/review-board">Review Board</a></li>
                <li><a href="/blog/category/rust">Rust</a></li>
                <li><a href="/blog/category/sync">Sync</a></li>
                <li><a href="/blog/category/browsers">browsers</a></li>
                <li><a href="/blog/category/build-system">build system</a></li>
                <li><a href="/blog/category/code-review">code review</a></li>
                <li><a href="/blog/category/compilers">compilers</a></li>
                <li><a href="/blog/category/internet">internet</a></li>
                <li><a href="/blog/category/logging">logging</a></li>
                <li><a href="/blog/category/mach">mach</a></li>
                <li><a href="/blog/category/make">make</a></li>
                <li><a href="/blog/category/misc">misc</a></li>
                <li><a href="/blog/category/movies">movies</a></li>
                <li><a href="/blog/category/pymake">pymake</a></li>
                <li><a href="/blog/category/security">security</a></li>
                <li><a href="/blog/category/sysadmin">sysadmin</a></li>
                <li><a href="/blog/category/testing">testing</a></li>
              </ul>
            </li>
          </ul>
        </div>



              <div style="clear: both;">&nbsp;</div>
          </div>
        </div>
      </div>
      <div id="footer">
        
  <hr/>
  <p>Copyright (c) 2012- Gregory Szorc. All rights reserved. Design by <a href="http://www.freecsstemplates.org/"> CSS Templates</a>.</p>


      </div>
    </div>
  </body>
</html>





