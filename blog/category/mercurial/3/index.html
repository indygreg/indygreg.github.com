


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by Free CSS Templates
http://www.freecsstemplates.org
Released for free under a Creative Commons Attribution 2.5 License

Name       : Pollinating  
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20101114

-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    
  <title>Gregory Szorc's Digital Home
</title>
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
<link rel="alternate" type="application/atom+xml" title="Atom 1.0"
href="/blog/feed/atom" />
<link rel="stylesheet" href="/style/style.css" type="text/css" />
<link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />


  </head>
  <body>
    <div id="wrapper">
      
  <div id="menu">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/notes">Notes</a></li>
    <li><a href="/work.html">Work</a></li>
    <li><a href="/skills.html">Skills</a></li>
    <li><a href="/thoughts.html">Thoughts</a></li>
    <li><a href="/resume.pdf">Resume</a></li>
  </ul>
</div>


      <div id="page">
        <div id="page-bgtop">
          <div id="page-bgbtm">
              <div id="content">
                
  
<div class="blog_post">
  <a name="dropping-explicit-support-for-mercurial-3.0"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/05/07/dropping-explicit-support-for-mercurial-3.0" rel="bookmark" title="Permanent Link to Dropping Explicit Support for Mercurial 3.0">Dropping Explicit Support for Mercurial 3.0</a></h2>
  <small>May 07, 2015 at 04:05 PM | categories: 

<a href='/blog/category/mercurial'>Mercurial</a>, <a href='/blog/category/mozilla'>Mozilla</a>
 | <a href="http://gregoryszorc.com/blog/2015/05/07/dropping-explicit-support-for-mercurial-3.0#disqus_thread">View Comments</a>
</small><p/>
  <div class="post_prose">
    
  <p>As of a few minutes ago, we explicitly dropped support for Mercurial 3.0
for all the Mercurial code in the
<a href="https://hg.mozilla.org/hgcustom/version-control-tools">version-control-tools</a>
repository. File issues in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1162304">bug 1162304</a>.</p>
<p>Code may still work against Mercurial 3.0. But it isn't supported and
could break hard at any time.</p>
<p>Supporting multiple versions of <em>any</em> software carries
with it some cost. The people writing tooling around Mercurial are busy.
It is a waste of our time to bend over backwards to support old versions
of software that <strong>all</strong> users should have upgraded from months ago.
Still using older Mercurial versions means you aren't getting the best
performance and may encounter bugs that have since been fixed.</p>
<p>See the <a href="https://mozilla-version-control-tools.readthedocs.org/en/latest/hgmozilla/installing.html">Mozilla tailored Mercurial installation instructions</a>
for info on how to upgrade to the latest/greatest Mercurial version.</p>

  </div>
</div>



  <div class="after_post"><a href="http://gregoryszorc.com/blog/2015/05/07/dropping-explicit-support-for-mercurial-3.0#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  
<div class="blog_post">
  <a name="reporting-mercurial-issues"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/05/04/reporting-mercurial-issues" rel="bookmark" title="Permanent Link to Reporting Mercurial Issues">Reporting Mercurial Issues</a></h2>
  <small>May 04, 2015 at 01:45 PM | categories: 

<a href='/blog/category/mercurial'>Mercurial</a>, <a href='/blog/category/mozilla'>Mozilla</a>
 | <a href="http://gregoryszorc.com/blog/2015/05/04/reporting-mercurial-issues#disqus_thread">View Comments</a>
</small><p/>
  <div class="post_prose">
    
  <p>I semi-frequently stumble upon conversations in hallways and
on irc.mozilla.org about issues people are having with Mercurial.
These conversations periodically involve a legitimate bug with
Mercurial. Unfortunately, these conversations frequently end
without an actionable result. Unless someone files a bug, pings me,
etc, the complaints disappear into ether. That's not good for
anyone and only results in bugs living longer than they should.</p>
<p>There are posters around Mozilla offices that say
<em>if you see something, file something.</em> This advice does not just
apply to Mozilla projects!</p>
<p><strong>If you encounter an issue in Mercurial, please take the time
to report it somewhere meaningful.</strong> The
<a href="https://mozilla-version-control-tools.readthedocs.org/en/latest/hgmozilla/issues.html">Reporting Issues with Mercurial</a>
page from the
<a href="https://mozilla-version-control-tools.readthedocs.org/en/latest/hgmozilla/index.html">Mercurial for Mozillians</a>
guide tells you how to do this.</p>
<p>It is OK to complain about something. But if you don't inform
someone empowered to do something about it, you are part of the
problem without being part of the solution. Please make the
incremental effort to be part of the solution.</p>

  </div>
</div>



  <div class="after_post"><a href="http://gregoryszorc.com/blog/2015/05/04/reporting-mercurial-issues#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  
<div class="blog_post">
  <a name="mercurial-3.4-released"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/05/04/mercurial-3.4-released" rel="bookmark" title="Permanent Link to Mercurial 3.4 Released">Mercurial 3.4 Released</a></h2>
  <small>May 04, 2015 at 12:40 PM | categories: 

<a href='/blog/category/mercurial'>Mercurial</a>, <a href='/blog/category/mozilla'>Mozilla</a>
 | <a href="http://gregoryszorc.com/blog/2015/05/04/mercurial-3.4-released#disqus_thread">View Comments</a>
</small><p/>
  <div class="post_prose">
    
  <p>Mercurial 3.4 was released on May 1 (following Mercurial's time-based
schedule of releasing a new version every 3 months).</p>
<p>3.4 is a significant release for a few reasons.</p>
<p>First, the next version of the wire protocol (<em>bundle2</em>) has been
marked as non-experimental on servers. This version of the protocol
paves over a number of deficiencies in the classic protocol. I won't
go into low-level details. But I will say that the protocol enables
some rich end-user experiences, such as having the server hand out URLs
for pre-generated bundles (e.g. offload clones to S3), atomic push
operations, and advanced workflows, such as having the server rebase
automatically on push. Of course, you'll need a server running 3.4
to realize the benefits of the new protocol. hg.mozilla.org won't be
updated until at least June 1.</p>
<p>Second, Mercurial 3.4 contains improvements to the tags cache to make
performance concerns a thing of the past. Due to the structure of the
Firefox repositories, the previous implementation of the tags cache
could result in pauses of dozens of seconds during certain workflows.
The problem should go away with Mercurial 3.4. <strong>Please note that on
first use of Mercurial 3.4, your repository may perform a one-time
upgrade of the tags cache. This will spin a full CPU core and will
take up to a few minutes to complete on Firefox repos. Let it run to
completion and performance should not be an issue again.</strong> I wrote the
patches to change the tags cache (with lots of help from Pierre-Yves
David, a Mercurial core contributor). So if you find anything wrong,
I'm the one to complain to.</p>
<p>Third, the HTTP interface to Mercurial (hgweb) now has JSON output
for nearly every endpoint. The implementation isn't yet complete,
but it is better than nothing. But, it should be good enough for
services to start consuming it. Again, this won't be available on
hg.mozilla.org until the server is upgraded on June 1 at the earliest.
This is a feature I added to core Mercurial. If you have feature
requests, send them my way.</p>
<p>Fourth, a number of performance regressions introduced in Mercurial
3.3 were addressed. These performance issues frequently manifested
during <em>hg blame</em> operations. Many Mozillians noticed them on
hg.mozilla.org when looking at blame through the web interface.</p>
<p>For a more comprehensive list of changes, see
<a href="https://groups.google.com/d/msg/mozilla.dev.version-control/z4aWvBoAGYw/d0hUGKJU_psJ">my post about the 3.4 RC</a>
and the
<a href="http://mercurial.selenic.com/wiki/WhatsNew#Mercurial_3.4_.282015-05-01.29">official release notes</a>.</p>
<p>3.4 was a significant release. There are compelling reasons to upgrade.
That being said, there were a lot of changes in 3.4. If you want to wait
until 3.4.1 is released (scheduled for June 1) so you don't run into
any regressions, nobody can fault you for that.</p>
<p>If you want to upgrade, I recommend reading the
<a href="https://mozilla-version-control-tools.readthedocs.org/en/latest/hgmozilla/installing.html">Mercurial for Mozillians Installation Page</a>.</p>

  </div>
</div>



  <div class="after_post"><a href="http://gregoryszorc.com/blog/2015/05/04/mercurial-3.4-released#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  
<div class="blog_post">
  <a name="automatically-redirecting-mercurial-pushes"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/04/30/automatically-redirecting-mercurial-pushes" rel="bookmark" title="Permanent Link to Automatically Redirecting Mercurial Pushes">Automatically Redirecting Mercurial Pushes</a></h2>
  <small>April 30, 2015 at 12:30 PM | categories: 

<a href='/blog/category/mercurial'>Mercurial</a>, <a href='/blog/category/mozilla'>Mozilla</a>
 | <a href="http://gregoryszorc.com/blog/2015/04/30/automatically-redirecting-mercurial-pushes#disqus_thread">View Comments</a>
</small><p/>
  <div class="post_prose">
    
  <p>Managing URLs in distributed version control tools can be a pain,
especially if multiple repositories are involved. For example,
with Mozilla's repository-based code review workflow (you push to a
special review repository to initiate code review - this is conceptually
similar to GitHub pull requests), there exist
<a href="https://reviewboard-hg.mozilla.org/">separate code review repositories</a>
for each logical repository. Figuring out how repositories map to each
other and setting up remote paths for each new clone can be a pain and
time sink.</p>
<p>As of today, we can now do something better.</p>
<p>If you push to <em>ssh://reviewboard-hg.mozilla.org/autoreview</em>,
Mercurial will automatically figure out the appropriate review
repository and redirect your push automatically. In other words, if we
have <a href="https://reviewboard.mozilla.org/">MozReview</a> set up to review
whatever repository you are working on,
your push and review request will automatically go through. No need to
figure out what the appropriate review repo is or configure
repository URLs!</p>
<p>Here's what it looks like:</p>
<div class="pygments_murphy"><pre>$ hg push review
pushing to ssh://reviewboard-hg.mozilla.org/autoreview
searching for appropriate review repository
redirecting push to ssh://reviewboard-hg.mozilla.org/version-control-tools/
searching for changes
remote: adding changesets
remote: adding manifests
remote: adding file changes
remote: added 1 changesets with 1 changes to 1 files
remote: Trying to insert into pushlog.
remote: Inserted into the pushlog db successfully.
submitting 1 changesets for review

changeset:  11043:b65b087a81be
summary:    mozreview: create per-commit identifiers (bug 1160266)
review:     https://reviewboard.mozilla.org/r/7953 (draft)

review id:  bz://1160266/gps
review url: https://reviewboard.mozilla.org/r/7951 (draft)
(visit review url to publish this review request so others can see it)
</pre></div>

<p>Read the <a href="https://mozilla-version-control-tools.readthedocs.org/en/latest/mozreview/install.html#review-repositories">full instructions</a>
for more details.</p>
<p>This requires an updated <a href="https://hg.mozilla.org/hgcustom/version-control-tools/">version-control-tools</a>
repository, which you can get by running <em>mach mercurial-setup</em> from a
Firefox repository.</p>
<p>For those that are curious, the <em>autoreview</em> repo/server advertises a list
of repository URLs and their root commit SHA-1. The client automatically
sends the push to a URL sharing the same root commit. The
<a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/0b02cd388590">code</a>
is quite simple.</p>
<p>While this is only implemented for MozReview, I could envision us doing
something similar for other centralized repository-centric services, such
as <em>Try</em> and <em>Autoland</em>. Stay tuned.</p>

  </div>
</div>



  <div class="after_post"><a href="http://gregoryszorc.com/blog/2015/04/30/automatically-redirecting-mercurial-pushes#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
  
<div class="blog_post">
  <a name="new-high-scores-for-hg.mozilla.org"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/03/19/new-high-scores-for-hg.mozilla.org" rel="bookmark" title="Permanent Link to New High Scores for hg.mozilla.org">New High Scores for hg.mozilla.org</a></h2>
  <small>March 19, 2015 at 08:20 PM | categories: 

<a href='/blog/category/mercurial'>Mercurial</a>, <a href='/blog/category/mozilla'>Mozilla</a>
 | <a href="http://gregoryszorc.com/blog/2015/03/19/new-high-scores-for-hg.mozilla.org#disqus_thread">View Comments</a>
</small><p/>
  <div class="post_prose">
    
  <p>It's been a <a href="/blog/2015/03/18/network-events/">rough week</a>.</p>
<p>The very short summary of events this week is that both the Firefox
and Firefox OS release automation has been performing a denial of
service attack against
<a href="https://hg.mozilla.org/">hg.mozilla.org</a>.</p>
<p>On the face of it, this is nothing new. The release automation
is by far the top consumer of hg.mozilla.org data, requesting several
terabytes per day via several million HTTP requests from thousands of
machines in multiple data centers. The very nature of their existence
makes them a significant denial of service threat.</p>
<p>Lots of things went wrong this week. While a post mortem will shed
light on them, many fall under the umbrella of <em>release automation was
making more requests than it should have and was doing so in a way
that both increased the chances of an outage occurring and increased
the chances of a prolonged outage.</em> This resulted in the hg.mozilla.org
servers working harder than they ever have. As a result, we have some
new <em>high scores</em> to share.</p>
<ul>
<li>
<p>On UTC day March 19, hg.mozilla.org transferred 7.4 TB of data.
  This is a significant increase from the ~4 TB we expect on a typical
  weekday. (Even more significant when you consider that most load is
  generated during peak hours.)</p>
</li>
<li>
<p>During the 1300 UTC hour of March 17, the cluster received 1,363,628
  HTTP requests. No HTTP 503 Service Not Available errors were
  encountered in that window! 300,000 to 400,000 requests per hour is
  typical.</p>
</li>
<li>
<p>During the 0800 UTC hour of March 19, the cluster transferred 776 GB
  of repository data. That comes out to at least 1.725 Gbps on average
  (I didn't calculate TCP and other overhead). Anything greater than 250
  GB per hour is not very common. No HTTP 503 errors were served from
  the origin servers during this hour!</p>
</li>
</ul>
<p>We encountered many periods where hg.mozilla.org was operating more than
twice its normal and expected operating capacity and it was able to
handle the load just fine. As a server operator, I'm proud of this.
The servers were provisioned beyond what is normally needed of them and
it took a truly exceptional event (or two) to bring the service down.
This is generally a good way to do hosted services (you rarely want to be
barely provisioned because you fall over at the slighest change and you
don't want to be grossly over-provisioned because you are wasting money
on idle resources).</p>
<p>Unfortunately, the hg.mozilla.org service did fall over. Multiple times,
in fact. There is room to improve. As proud as I am that the service
operated well beyond its expected limits, I can't help but feel ashamed
that it did eventual cave in under even extreme load and that people are
probably making under-informed general assumptions like <em>Mercurial can't
scale</em>. The simple fact of the matter is that clients cumulatively
generated an exceptional amount of traffic to hg.mozilla.org this week.
All servers have capacity limits. And this week we encountered the limit
for the current configuration of hg.mozilla.org. Cause and effect.</p>

  </div>
</div>



  <div class="after_post"><a href="http://gregoryszorc.com/blog/2015/03/19/new-high-scores-for-hg.mozilla.org#disqus_thread">Read and Post Comments</a></div>
  <hr class="interblog" />
 <a href="/blog/category/mercurial/2">« Previous Page</a>
  --  
 <a href="/blog/category/mercurial/4">Next Page »</a>

              </div>
              
          <div id="sidebar">
          <ul>
            <li>
              <h2>Categories</h2>
              <ul>
                <li><a href="/blog/category/bugzilla">Bugzilla</a></li>
                <li><a href="/blog/category/clang">Clang</a></li>
                <li><a href="/blog/category/docker">Docker</a></li>
                <li><a href="/blog/category/firefox">Firefox</a></li>
                <li><a href="/blog/category/git">Git</a></li>
                <li><a href="/blog/category/javascript">JavaScript</a></li>
                <li><a href="/blog/category/mercurial">Mercurial</a></li>
                <li><a href="/blog/category/mozreview">MozReview</a></li>
                <li><a href="/blog/category/mozilla">Mozilla</a></li>
                <li><a href="/blog/category/puppet">Puppet</a></li>
                <li><a href="/blog/category/python">Python</a></li>
                <li><a href="/blog/category/review-board">Review Board</a></li>
                <li><a href="/blog/category/sync">Sync</a></li>
                <li><a href="/blog/category/browsers">browsers</a></li>
                <li><a href="/blog/category/build-system">build system</a></li>
                <li><a href="/blog/category/code-review">code review</a></li>
                <li><a href="/blog/category/compilers">compilers</a></li>
                <li><a href="/blog/category/internet">internet</a></li>
                <li><a href="/blog/category/logging">logging</a></li>
                <li><a href="/blog/category/mach">mach</a></li>
                <li><a href="/blog/category/make">make</a></li>
                <li><a href="/blog/category/misc">misc</a></li>
                <li><a href="/blog/category/movies">movies</a></li>
                <li><a href="/blog/category/pymake">pymake</a></li>
                <li><a href="/blog/category/security">security</a></li>
                <li><a href="/blog/category/sysadmin">sysadmin</a></li>
                <li><a href="/blog/category/testing">testing</a></li>
              </ul>
            </li>
          </ul>
        </div>



              <div style="clear: both;">&nbsp;</div>
          </div>
        </div>
      </div>
      <div id="footer">
        
  <hr/>
  <p>Copyright (c) 2015 Gregory Szorc. All rights reserved. Design by <a href="http://www.freecsstemplates.org/"> CSS Templates</a>.</p>


      </div>
    </div>
  </body>
</html>





