


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by Free CSS Templates
http://www.freecsstemplates.org
Released for free under a Creative Commons Attribution 2.5 License

Name       : Pollinating  
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20101114

-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    
  <title>Gregory Szorc's Digital Home
</title>
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
<link rel="alternate" type="application/atom+xml" title="Atom 1.0"
href="/blog/feed/atom" />
<link rel="stylesheet" href="/style/style.css" type="text/css" />
<link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />


  </head>
  <body>
    <div id="wrapper">
      
  <div id="menu">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/notes">Notes</a></li>
    <li><a href="/work.html">Work</a></li>
    <li><a href="/skills.html">Skills</a></li>
    <li><a href="/thoughts.html">Thoughts</a></li>
    <li><a href="/resume.pdf">Resume</a></li>
  </ul>
</div>


      <div id="page">
        <div id="page-bgtop">
          <div id="page-bgbtm">
              <div id="content">
                
  
<div class="blog_post">
  <a name="new-high-scores-for-hg.mozilla.org"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/03/19/new-high-scores-for-hg.mozilla.org" rel="bookmark" title="Permanent Link to New High Scores for hg.mozilla.org">New High Scores for hg.mozilla.org</a></h2>
  <small>March 19, 2015 at 08:20 PM | categories: 

<a href='/blog/category/mercurial'>Mercurial</a>, <a href='/blog/category/mozilla'>Mozilla</a>
</small><p/>
  <div class="post_prose">
    
  <p>It's been a <a href="/blog/2015/03/18/network-events/">rough week</a>.</p>
<p>The very short summary of events this week is that both the Firefox
and Firefox OS release automation has been performing a denial of
service attack against
<a href="https://hg.mozilla.org/">hg.mozilla.org</a>.</p>
<p>On the face of it, this is nothing new. The release automation
is by far the top consumer of hg.mozilla.org data, requesting several
terabytes per day via several million HTTP requests from thousands of
machines in multiple data centers. The very nature of their existence
makes them a significant denial of service threat.</p>
<p>Lots of things went wrong this week. While a post mortem will shed
light on them, many fall under the umbrella of <em>release automation was
making more requests than it should have and was doing so in a way
that both increased the chances of an outage occurring and increased
the chances of a prolonged outage.</em> This resulted in the hg.mozilla.org
servers working harder than they ever have. As a result, we have some
new <em>high scores</em> to share.</p>
<ul>
<li>
<p>On UTC day March 19, hg.mozilla.org transferred 7.4 TB of data.
  This is a significant increase from the ~4 TB we expect on a typical
  weekday. (Even more significant when you consider that most load is
  generated during peak hours.)</p>
</li>
<li>
<p>During the 1300 UTC hour of March 17, the cluster received 1,363,628
  HTTP requests. No HTTP 503 Service Not Available errors were
  encountered in that window! 300,000 to 400,000 requests per hour is
  typical.</p>
</li>
<li>
<p>During the 0800 UTC hour of March 19, the cluster transferred 776 GB
  of repository data. That comes out to at least 1.725 Gbps on average
  (I didn't calculate TCP and other overhead). Anything greater than 250
  GB per hour is not very common. No HTTP 503 errors were served from
  the origin servers during this hour!</p>
</li>
</ul>
<p>We encountered many periods where hg.mozilla.org was operating more than
twice its normal and expected operating capacity and it was able to
handle the load just fine. As a server operator, I'm proud of this.
The servers were provisioned beyond what is normally needed of them and
it took a truly exceptional event (or two) to bring the service down.
This is generally a good way to do hosted services (you rarely want to be
barely provisioned because you fall over at the slighest change and you
don't want to be grossly over-provisioned because you are wasting money
on idle resources).</p>
<p>Unfortunately, the hg.mozilla.org service did fall over. Multiple times,
in fact. There is room to improve. As proud as I am that the service
operated well beyond its expected limits, I can't help but feel ashamed
that it did eventual cave in under even extreme load and that people are
probably making under-informed general assumptions like <em>Mercurial can't
scale</em>. The simple fact of the matter is that clients cumulatively
generated an exceptional amount of traffic to hg.mozilla.org this week.
All servers have capacity limits. And this week we encountered the limit
for the current configuration of hg.mozilla.org. Cause and effect.</p>

  </div>
</div>



  <hr class="interblog" />
  
<div class="blog_post">
  <a name="network-events"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/03/18/network-events" rel="bookmark" title="Permanent Link to Network Events">Network Events</a></h2>
  <small>March 18, 2015 at 02:25 PM | categories: 

<a href='/blog/category/mozilla'>Mozilla</a>
</small><p/>
  <div class="post_prose">
    
  <p>The Firefox source repositories and automation have been closed the past
few days due to a couple of outages.</p>
<p>Yesterday, aggregate CPU usage on many of the machines in the hg.mozilla.org
cluster hit 100%. Previously, whenever hg.mozilla.org was under high load,
we'd run out of network bandwidth before we ran out of CPU on the machines.
In other words, Mercurial was generating data faster than the network could
accept it.</p>
<p>When this happened, the service started issuing HTTP 503 Service Not
Available responses. This is the universal server signal for <em>I'm down, go
away</em>. Unfortunately, not all clients did this.</p>
<p>Parts of Firefox's release automation retried failing requests
immediately, or with insufficient jitter in their backoff interval.
Actively retrying requests against a server that's experiencing load
issues only makes the problem worse. This effectively prolonged the
outage.</p>
<p>Today, we had a similar but different network issue. The load balancer
fronting hg.mozilla.org can only handle so much bandwidth. Today, we hit
that limit. The load balancer started throttling connections. Load on
hg.mozilla.org skyrocketed and request latency increased. From the
perspective of clients, the service grinded to a halt.</p>
<p>hg.mozilla.org was partially sharing a load balancer with
ftp.mozilla.org. That meant if one of the services experienced very high
load, the other service could effectively be <em>locked out</em> of bandwidth.
We saw this happening this morning. ftp.mozilla.org load was high (it
looks like downloads of Firefox Developer Edition are a major
contributor - these don't go through the CDN for reasons unknown to me)
and there wasn't enough bandwidth to go around.</p>
<p>Separately today, hg.mozilla.org again hit 100% CPU. At that time, it
also set a new record for network throughput: ~3 Gbps. It normally
consumes between 200 and 500 Mbps, with periodic spikes to 750 Mbps.
(Yesterday's event saw a spike to around ~2 Gbps.)</p>
<p>Going back through the hg.mozilla.org server logs, an offender is
quite obvious. Before March 9, total outbound transfer for the
<a href="https://hg.mozilla.org/build/tools/">build/tools</a> repo was around
1 tebibyte per day. Starting on March 9, it increased to 3 tebibytes per
day! This is quite remarkable, as a clone of this repo is only about
20 MiB. This means the repo was getting cloned about 150,000 times per
day! (Note: I think all these numbers may be low by ~20% - stay tuned
for the final analysis.)</p>
<p>2 TiB/day is statistically significant because we transfer less than 10
TiB/day across all of hg.mozilla.org. And, 1 TiB/day is close to 100
Mbps, assuming requests are evenly spread out (which of course they
aren't).</p>
<p>Multiple things went wrong. If only one or two happened, we'd likely be
fine. Maybe there would have been a short blip. But not the major event
we've been firefighting the last ~24 hours.</p>
<p>This post is only a summary of what went wrong. I'm sure there will be a
post-mortem and that it will contain lots of details for those who want
to know more.</p>

  </div>
</div>



  <hr class="interblog" />
  
<div class="blog_post">
  <a name="lost-productivity-due-to-non-unified-repositories"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/02/17/lost-productivity-due-to-non-unified-repositories" rel="bookmark" title="Permanent Link to Lost Productivity Due to Non-Unified Repositories">Lost Productivity Due to Non-Unified Repositories</a></h2>
  <small>February 17, 2015 at 02:50 PM | categories: 

<a href='/blog/category/mozilla'>Mozilla</a>
</small><p/>
  <div class="post_prose">
    
  <p>I'm currently working on
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1132771">annotating moz.build files with metadata</a>
that defines things like which bug component and code reviewers map to
which files. It's going to enable a lot of awesomeness.</p>
<p>As part of this project, I'm implementing a new moz.build processing
mode. Instead of reading moz.build files by traversing <em>DIRS</em> variables
from previously-executed moz.build files, we're evaluating moz.build
files according to filesystem topology. This has uncovered a few
cases where a moz.build file errors because of assumptions that no
longer hold. For example, for directories that are only active on
Windows, the moz.build file might assume that <em>if Windows</em> is always true.</p>
<p>One such problem was with
<a href="https://dxr.mozilla.org/mozilla-central/source/gfx/angle/src/libGLESv2/moz.build">gfx/angle/srx/libGLESv2/moz.build</a>.
This file contained code similar to the following:</p>
<pre><code>if CONFIG['IS_WINDOWS']:
    SOURCES += ['foo.cpp']
...
SOURCES['foo.cpp'].flags += ['-DBAR']
</code></pre>
<p>This always ran without issue because this moz.build was only included
if building for Windows. This assumption is of course invalid when in
filesystem traversal mode.</p>
<p>Anyway, as part of updating this trouble file, I lost maybe an hour
of productivity. Here's how.</p>
<p>The top of the trouble moz.build file has a comment:</p>
<pre><code># Please note this file is autogenerated from generate_mozbuild.py,
# so do not modify it directly
</code></pre>
<p>OK. So, I need to modify <em>generate_mozbuild.py</em>. First thing's first: I
need to locate it:</p>
<pre><code>$ hg locate generate_mozbuild.py
gfx/skia/generate_mozbuild.py
</code></pre>
<p>So I load up this file. I see a <em>main()</em>. I run the script in my shell
and get an error. Weird. I look around <em>gfx/skia</em> and see a README_MOZILLA
file. I open it. README_MOZILLA contains some instructions. They aren't
very good. I hop in #gfx on IRC and ask around. They tell me to do a
Subversion clone of Skia and to check out the commit referenced in
README_MOZILLA. There is no repo URL in README_MOZILLA. I search Google.
I find a Git URL. I notice that README_MOZILLA contains a SHA-1 commit,
not a Subversion integer revision. I figure the Git repo is what was
meant. I clone the Git repo. I attempt to run the generation script
referenced by README_MOZILLA. It fails. I ask again in #gfx. They are
baffled at first. I dig around the source code. I see a reference in
Skia's upstream code to a path that doesn't exist. I tell the #gfx
people. They tell me sub-repos are likly involved and to use <em>gclient</em>
to clone the repo. I search for the proper Skia source code docs and
type the necessary gclient commands. (Fortunately I've used gclient
before, so this wasn't completely alien to me.)</p>
<p>I get the Skia clone in the proper state. I run the generation script
and all works. But I don't see it writing the trouble moz.build file I
set out to fix. I set some breakpoints. I run the code again. I'm
baffled.</p>
<p>Suddenly it hits me: I've been poking around with <em>gfx/skia</em> which is
separate from <em>gfx/angle</em>! I look around <em>gfx/angle</em> and see
a README.mozilla file. I open it. It reveals the existence of the Git
repo <a href="https://github.com/mozilla/angle">https://github.com/mozilla/angle</a>.
I open GitHub in my browser. I see a <em>generate_mozbuild.py</em> script.</p>
<p>I now realize there are multiple files named <em>generate_mozbuild.py</em>.
Unfortunately, the one I care about - the ANGLE one - is not checked
into mozilla-central. So, my search for it with <em>hg files</em> did not
reveal its existence. Between me trying to get the Skia code cloned and
generating moz.build files, I probably lost an hour of work. All because
a file with a similar name wasn't checked into mozilla-central!</p>
<p>I assumed that the single <em>generate_mozbuild.py</em> I found under source
control was the only file of that name and that it <em>must</em> be the file
I was interested in.</p>
<p>Maybe I should have known to look at <em>gfx/angle/README.mozilla</em> first.
Maybe I should have known that <em>gfx/angle</em> and <em>gfx/skia</em> are completely
independent.</p>
<p>But I didn't. My ignorance cost me.</p>
<p>Had the contents of the separate ANGLE repository been checked into
mozilla-central, I would have seen the multiple <em>generate_mozbuild.py</em>
files and I would likely have found the correct one immediately. But
they weren't and I lost an hour of my time.</p>
<p>And I'm not done. Now I have to figure out how the separate ANGLE repo
integrates with mozilla-central. I'll have to figure out how to submit the
patch I still need to write. The GitHub description of this repo says
<em>Talk to vlad, jgilbert, or kamidphish for more info</em>. So now I have to
bother them before I can submit my patch. Maybe I'll just submit a pull
request and see what happens.</p>
<p>I'm convinced I wouldn't have encountered this problem if a
<a href="/blog/2014/09/09/on-monolithic-repositories/">monolithic repository</a>
were used. I would have found the separate <em>generate_mozbuild.py</em> file
immediately. And, the change process would likely have been known to me
since all the code was in a repository I already knew how to submit
patches from.</p>
<p>Separate repos are just lots of pain. You can bet I'll link to this post
when people propose splitting up mozilla-central into multiple
repositories.</p>

  </div>
</div>



  <hr class="interblog" />
  
<div class="blog_post">
  <a name="branch-cleanup-in-firefox-repositories"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/01/28/branch-cleanup-in-firefox-repositories" rel="bookmark" title="Permanent Link to Branch Cleanup in Firefox Repositories">Branch Cleanup in Firefox Repositories</a></h2>
  <small>January 28, 2015 at 08:35 PM | categories: 

<a href='/blog/category/mercurial'>Mercurial</a>, <a href='/blog/category/mozilla'>Mozilla</a>
</small><p/>
  <div class="post_prose">
    
  <p>Mozilla has historically done some funky things with the Firefox
Mercurial repositories. One of the things we've done is create
a bunch of named branches to track the Firefox release process.
These are branch names like <em>GECKO20b12_2011022218_RELBRANCH</em>.</p>
<p>Over in
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=927219">bug 927219</a>,
we started the process of cleaning up some cruft left over from
many of these old branches.</p>
<p>For starters, the old named branches in the Firefox repositories
are being actively closed. When you <em>hg commit --close-branch</em>,
Mercurial creates a special commit that says <em>this branch is closed</em>.
Branches that are closed are automatically hidden from the output
of <em>hg branches</em> and <em>hg heads</em>. As a result, the output of these
commands is now much more usable.</p>
<p>Closed branches still constitute <em>heads</em> on the DAG. And several heads
lead to degraded performance in some situations (notably push and pull
times - the same thing happens in Git). I'd like to eventually merge
these old heads so that repositories only have 1 or a small number of
DAG heads. However, extra care must be taken before that step. Stay
tuned.</p>
<p>Anyway, for the average person reading, you probably won't be impacted
by these changes at all. The greatest impact will be from the person who
lands the first change on top of any repository whose last commit
was a branch close. If you commit on top of the <em>tip</em> commit,
you'll be committing on top of a previously closed branch! You'll
instead want to <em>hg up default</em> after you pull to ensure you are on
the proper DAG head! And even then, if you have local commits, you may
not be based on top of the appropriate commit! A simple run of
<em>hg log --graph</em> should help you decipther the state of the world.
(Please note that the usability problems around discovering the
appropriate head to land on are a result of our poor branching strategy
for the Firefox repositories. We probably should have named branches
tracking the active Gecko releases. But that ship sailed years ago
and fixing that is pretty far down the priority list. Wallpapering
over things with the
<a href="https://mozilla-version-control-tools.readthedocs.org/en/latest/hgmozilla/firefoxtree.html">firefoxtree extensions</a>
is my recommended solution until matters are fixed.)</p>

  </div>
</div>



  <hr class="interblog" />
  
<div class="blog_post">
  <a name="commit-part-numbers-and-mozreview"></a>
  <h2 class="blog_post_title"><a href="/blog/2015/01/27/commit-part-numbers-and-mozreview" rel="bookmark" title="Permanent Link to Commit Part Numbers and MozReview">Commit Part Numbers and MozReview</a></h2>
  <small>January 27, 2015 at 08:17 PM | categories: 

<a href='/blog/category/mozreview'>MozReview</a>, <a href='/blog/category/mozilla'>Mozilla</a>, <a href='/blog/category/code-review'>code review</a>
</small><p/>
  <div class="post_prose">
    
  <p>It is common for commit messages in Firefox to contains strings like
<em>Part 1</em>, <em>Part 2</em>, etc. See
<a href="https://hg.mozilla.org/projects/build-system/pushloghtml?changeset=5cb8bcab09cc">this push</a>
for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=784841">bug 784841</a>
for an extreme multi-part example.</p>
<p>When code review is conducted in Bugzilla, these identifiers are
necessary because Bugzilla orders attachments/patches in the order they
were updated or their patch title (I'm not actually sure!). If part
numbers were omitted, it could be very confusing trying to figure out
which order patches should be applied in.</p>
<p>However, when code review is conducted in
<a href="https://mozilla-version-control-tools.readthedocs.org/en/latest/mozreview.html">MozReview</a>,
<strong>there is no need for explicit part numbers to convey ordering</strong> because
the ordering of commits is implicitly defined by the repository history
that you pushed to MozReview!</p>
<p>I argue that if you are using MozReview, you should stop writing <em>Part
N</em> in your commit messages, as it provides little to no benefit.</p>
<p>I, for one, welcome this new world order: I've previously wasted a lot
of time rewriting commit messages to reflect new part ordering after
doing history rewriting. With MozReview, that overhead is gone and I
barely pay a penalty for rewriting history, something that often
produces a more reviewable series of commits and makes reviewing
and landing a complex patch series significantly easier.</p>

  </div>
</div>



  <hr class="interblog" />
 <a href="../11">« Previous Page</a>
  --  
 <a href="../13">Next Page »</a>

              </div>
              
          <div id="sidebar">
          <ul>
            <li>
              <h2>Categories</h2>
              <ul>
                <li><a href="/blog/category/apple">Apple</a></li>
                <li><a href="/blog/category/bugzilla">Bugzilla</a></li>
                <li><a href="/blog/category/clang">Clang</a></li>
                <li><a href="/blog/category/docker">Docker</a></li>
                <li><a href="/blog/category/firefox">Firefox</a></li>
                <li><a href="/blog/category/git">Git</a></li>
                <li><a href="/blog/category/javascript">JavaScript</a></li>
                <li><a href="/blog/category/mercurial">Mercurial</a></li>
                <li><a href="/blog/category/mozreview">MozReview</a></li>
                <li><a href="/blog/category/mozilla">Mozilla</a></li>
                <li><a href="/blog/category/personal">Personal</a></li>
                <li><a href="/blog/category/puppet">Puppet</a></li>
                <li><a href="/blog/category/pyoxidizer">PyOxidizer</a></li>
                <li><a href="/blog/category/python">Python</a></li>
                <li><a href="/blog/category/review-board">Review Board</a></li>
                <li><a href="/blog/category/rust">Rust</a></li>
                <li><a href="/blog/category/sync">Sync</a></li>
                <li><a href="/blog/category/browsers">browsers</a></li>
                <li><a href="/blog/category/build-system">build system</a></li>
                <li><a href="/blog/category/code-review">code review</a></li>
                <li><a href="/blog/category/compilers">compilers</a></li>
                <li><a href="/blog/category/internet">internet</a></li>
                <li><a href="/blog/category/logging">logging</a></li>
                <li><a href="/blog/category/mach">mach</a></li>
                <li><a href="/blog/category/make">make</a></li>
                <li><a href="/blog/category/misc">misc</a></li>
                <li><a href="/blog/category/movies">movies</a></li>
                <li><a href="/blog/category/pymake">pymake</a></li>
                <li><a href="/blog/category/security">security</a></li>
                <li><a href="/blog/category/sysadmin">sysadmin</a></li>
                <li><a href="/blog/category/testing">testing</a></li>
              </ul>
            </li>
          </ul>
        </div>



              <div style="clear: both;">&nbsp;</div>
          </div>
        </div>
      </div>
      <div id="footer">
        
  <hr/>
  <p>Copyright (c) 2012- Gregory Szorc. All rights reserved. Design by <a href="http://www.freecsstemplates.org/"> CSS Templates</a>.</p>


      </div>
    </div>
  </body>
</html>





